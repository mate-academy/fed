#!/usr/bin/env node

"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var i=require("commander"),e=t(require("fs")),o=t(require("path")),s=t(require("fs-extra")),n=require("child_process");const r="@mate-academy/scripts";var c="0.0.38";function a(t){return t.includes("package.json")}function l(t){if("test"===process.env.NODE_ENV)return!0;let i;try{const s=e.readFileSync(o.join(t,"package.json"),{encoding:"utf-8"});i=JSON.parse(s)}catch(t){i=null}return i&&i.devDependencies&&i.devDependencies["@mate-academy/scripts"]}function h(t){return"/"===t}var p,m,u,d,y,g;!function(t){t.None="none",t.Layout="layout",t.Javascript="javascript",t.React="react",t.ReactTypescript="reactTypescript"}(p||(p={}));class f{constructor(t){this.projectType=p.None,this.throwNoImplementationError=()=>{throw new Error(`No implementation for command ${this.constructor.name} for ${this.projectType} project`)},this[m]=this.throwNoImplementationError,this[u]=this.throwNoImplementationError,this[d]=this.throwNoImplementationError,this[y]=this.throwNoImplementationError,this[g]=this.throwNoImplementationError,this.rootDir=t}async run(t){this.setProjectType(),await this.common(t),await this[this.projectType](t)}setProjectType(){if(this.projectType!==p.None)return;const{mateAcademy:t}=JSON.parse(s.readFileSync(o.join(this.rootDir,"package.json"),{encoding:"utf-8"}));t&&t.projectType||f.throwProjectTypeError(),this.projectType=t.projectType}static throwProjectTypeError(){throw new Error('package.json should contain\n{\n  ...\n  "mateAcademy": {\n    "projectType": "layout" | "javascript" | "react" | "reactTypescript"\n  }\n}\n')}child(t){return new t(this.rootDir)}}function j(t,i=!0){let e={stdio:"ignore"};i&&(e={stdio:"inherit"}),n.execSync(t,e)}function D(t,i=!0){try{j(t,i)}catch(t){process.exit(1)}}m=p.None,u=p.Layout,d=p.Javascript,y=p.React,g=p.ReactTypescript;class k{constructor(t){return this.rootDir=t,this.configPath=o.join(this.rootDir,"./backstopConfig.js"),this.dataDir=o.join(this.rootDir,"backstop_data"),this.referencesDir=o.join(this.dataDir,"bitmaps_reference"),this.testResultsDir=o.join(this.dataDir,"bitmaps_test"),this.htmlReportDir=o.join(this.dataDir,"html_report"),k.__instance||(k.__instance=this),k.__instance}test(){this.ensureReferences(),this.cleanTestResults(),k.run("test",{config:this.configPath})}ensureReferences(){this.areReferencesExists()||this.loadReferences()}areReferencesExists(){return s.existsSync(this.referencesDir)}cleanTestResults(){s.removeSync(this.testResultsDir)}loadReferences(){this.cleanReference(),k.run("reference",{config:this.configPath})}cleanReference(){s.removeSync(this.referencesDir)}static run(t,i){D(`backstop ${t} ${Object.entries(i).reduce((t,[i,e])=>`${t} --${i}=${e}`,"")}`)}}let v=(()=>{class t extends f{constructor(){super(...arguments),this.gitHooksDestinationDir=o.join(this.rootDir,"./.git/hooks"),this.backstop=new k(this.rootDir),this.layout=()=>{this.copyLayoutConfigs(),this.copyLinthtmlConfig(),this.backstop.loadReferences()}}common(){this.copyCommonConfigs(),this.initGitHooks()}copyCommonConfigs(){const i=o.join(t.configsDir,"common");s.copySync(i,this.rootDir)}copyLayoutConfigs(){const i=o.join(t.configsDir,"layout");s.copySync(i,this.rootDir)}copyLinthtmlConfig(){const i=o.join(this.rootDir,t.lintHtmlConfigDir,t.lintHtmlConfigFileName),e=o.join(this.rootDir,t.lintHtmlConfigFileName);s.copyFileSync(i,e)}initGitHooks(){s.readdirSync(t.gitHooksSourceDir).forEach(t=>this.initGitHook(t))}initGitHook(i){const e=o.join(t.gitHooksSourceDir,i),n=o.join(this.gitHooksDestinationDir,i);s.copySync(e,n),t.makeGitHookExecutable(n)}static makeGitHookExecutable(t){j("chmod +x "+t)}}return t.lintHtmlConfigDir="node_modules/@mate-academy/linthtml-config",t.lintHtmlConfigFileName=".linthtmlrc.json",t.configsDir=o.join(__dirname,"../configs"),t.gitHooksSourceDir=o.join(t.configsDir,"git-hooks"),t})();class w{constructor(t){return this.rootDir=t,w.__instance||(w.__instance=this),w.__instance}build(t="dist"){j("gulp build --destination "+t)}serve(t="dist"){j("gulp --destination "+t)}}class b extends f{constructor(){super(...arguments),this.layout=t=>{console.log("layout",t);const{html:i,files:e}=t;i&&b.lintHtml(e)}}common(t){const{styles:i,javascript:e,files:o}=t;console.log("common",t),i&&b.lintStyles(o),e&&b.lintJs(o)}static lintHtml(t){D("linthtml "+(t?t.join(" "):"./src/**/*.html"))}static lintStyles(t){D("stylelint "+(t?t.join(" "):"./src/**/*.css ./src/**/*.scss"))}static lintJs(t){D("eslint "+(t?t.join(" "):"./src"))}}class S extends f{constructor(){super(...arguments),this.gulp=new w(this.rootDir),this.layout=()=>{this.gulp.build("dist")}}common(){}}class _ extends f{constructor(){super(...arguments),this.buildCommand=this.child(S),this.destinationDir=o.join(this.rootDir,"dist"),this.backstop=new k(this.rootDir),this.layout=async()=>{await this.buildCommand.run(),console.log("Start deploy to gh-pages\n");try{this.copyHtmlReport(),this.commitBuild(),_.ensureCanPush(),_.pushGhPagesSubtree(),console.log("Deployed to gh-pages successfully\n")}catch(t){console.log("Error during deploy to gh-pages:"),console.error(t.message)}finally{this.clean()}}}common(){}copyHtmlReport(){s.copySync(o.join(this.backstop.htmlReportDir),o.join(this.destinationDir,"./report/html_report"))}commitBuild(){j(`git add ${this.destinationDir} -f`,!1),j('git commit -m "make build" --no-verify',!1)}static ensureCanPush(){!function(t,i=!0){try{j(t,i)}catch(t){}}("git push --delete origin gh-pages",!1)}static pushGhPagesSubtree(){j("git subtree push --prefix dist origin gh-pages",!1)}clean(){j("git reset --soft HEAD^",!1),j("git restore --staged "+this.destinationDir,!1),s.removeSync(this.destinationDir)}}const H=new i.Command,R=new class{constructor(){this.rootDir=function(){let t=process.cwd(),i=e.readdirSync(t);for(;!a(i)||!l(t);){if(h(t))throw new Error("Command should be run inside project folder with @mate-academy/scripts as devDependency");t=o.join(t,"../"),i=e.readdirSync(t)}return t}()}make(t,i){const e=new t(this.rootDir);return i?(...t)=>{const o=t.pop(),s=i(o,...t);return e.run(s)}:()=>e.run()}};H.name("mate-scripts").version(c,"-v --version","output current version"),H.command("init").description("init linters and configs").action(R.make(v)),H.command("start").description("run development server").action(R.make(class extends f{constructor(){super(...arguments),this.gulp=new w(this.rootDir),this.layout=()=>{this.gulp.serve("dist")}}common(){}})),H.command("lint [files...]").option("-s, --styles","lint styles only",!1).option("-h, --html","lint html only",!1).option("-j, --javascript","lint javascript only",!1).description("lint html, css and js files").action(R.make(b,(t,i)=>{const{styles:e,html:o,javascript:s}=t,n=i&&i.length?i:null;return e||o||s?{styles:e,html:o,javascript:s,files:n}:{styles:!0,html:!0,javascript:!0,files:n}})),H.command("test").description("run tests").action(R.make(class extends f{constructor(){super(...arguments),this.backstop=new k(this.rootDir),this.layout=()=>{this.backstop.test()}}common(){}})),H.command("build").description("create production ready build").action(R.make(S)),H.command("deploy").description("deploy application to gh-pages").action(R.make(_)),H.command("update").description("update @mate-academy/scripts").action(R.make(class extends f{constructor(){super(...arguments),this.layout=()=>{},this.javascript=()=>{},this.react=()=>{},this.reactTypescript=()=>{}}common(){j(`npm install -D ${r}@latest`),j("npm run init")}})),H.parse(process.argv);
